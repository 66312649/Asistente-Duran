<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HUD Voz ‚Äì Prototipo v2</title>
  <style>
    :root{ --bg:#05070a; --fg:#eaf7ff; --muted:#88a2ad; --accent:#3cf5ff; --accent2:#ff4b7d; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:radial-gradient(1200px 800px at 65% 40%, #0b1117 0%, #080d12 40%, #05070a 70% , #030508 100%); color:var(--fg); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}

    /* Layout */
    .hud{position:relative; width:100vw; height:100vh; overflow:hidden}
    .topbar{position:absolute; inset:0 0 auto 0; display:flex; justify-content:space-between; padding:18px 22px; pointer-events:none}
    .brand{font-weight:800; letter-spacing:.6px; font-size:14px; color:#9bb2bb}
    .datetime{font-variant-numeric:tabular-nums; color:#9bb2bb}

    /* Core mic */
    .core{position:absolute; inset:0; display:grid; place-items:center}
    .wrap{position:relative; width:min(64vmin,720px); aspect-ratio:1/1}
    .mic-btn{position:absolute; inset:0; border:none; background:transparent; cursor:pointer}
    svg{position:absolute; inset:0; width:100%; height:100%}
    .ring{filter:drop-shadow(0 0 18px rgba(60,245,255,.65))}
    .ticks{opacity:.6}
    .pulse{transform-origin:50% 50%; transition:transform .08s ease-out}

    /* Equalizador circular (sustituye aros flotando) */
    .bar { transform-origin:50% 50%; }

    /* Greeting */
    .greet{position:absolute; left:24px; bottom:24px; font-size:18px; font-weight:700}
    .greet small{display:block; color:#9bb2bb; font-weight:500; font-size:12px; margin-top:6px}

    /* Branches (almacenes) */
    .branches{position:absolute; left:24px; bottom:140px; width:min(520px, 60vw)}
    .branch{display:flex; align-items:center; gap:12px; margin:14px 0}
    .branch .line{flex:1; height:2px; background:linear-gradient(90deg, #2a424a, var(--accent)); box-shadow:0 0 10px rgba(60,245,255,.35)}
    .branch button{all:unset; cursor:pointer; font-weight:800; letter-spacing:.5px; padding:10px 14px; border:1px solid #16323a; border-radius:999px; background:linear-gradient(180deg,#0c1419, #0a1014); box-shadow: inset 0 0 0 1px #17323a, 0 0 12px rgba(60,245,255,.18)}
    .branch button:hover{box-shadow: inset 0 0 0 1px var(--accent), 0 0 18px rgba(60,245,255,.35)}
    .branches .title{font-size:12px; color:#9bb2bb; text-transform:uppercase; letter-spacing:1px; margin:0 0 8px 0}

    /* Idiomas (ramas derechas) */
    .langs{position:absolute; right:24px; bottom:140px; width:min(520px, 60vw)}
    .langs .title{font-size:12px; color:#9bb2bb; text-transform:uppercase; letter-spacing:1px; margin:0 0 8px 0}
    .langs .branch{justify-content:flex-end}
    .langs .branch .line{background:linear-gradient(90deg, var(--accent), #2a424a)}

    /* Panel transcripci√≥n */
    .panel{position:absolute; left:24px; top:24px; width:min(520px, 55vw); border:1px solid #162229; background:rgba(5,8,11,.75); backdrop-filter: blur(6px); border-radius:16px; padding:14px 16px; box-shadow:0 0 0 1px #0d2026, 0 20px 60px rgba(0,0,0,.5)}
    .panel h3{margin:0 0 6px 0; font-size:12px; color:#9bb2bb; letter-spacing:1px; text-transform:uppercase}
    .bubble{margin:8px 0 0 0; border:1px dashed #28424a; border-radius:12px; padding:12px; color:#bcd1d8; min-height:48px; font-size:14px}

    /* Estado */
    .status{position:absolute; left:24px; bottom:84px; display:flex; align-items:center; gap:10px; font-size:12px; color:#9bb2bb}
    .led{width:10px; height:10px; border-radius:50%; background:#3a454c}
    .active .led{background:var(--accent); box-shadow:0 0 10px rgba(60,245,255,.9)}

    /* Reloj lateral ultramoderno */
    .sideclock{position:absolute; right:24px; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; align-items:flex-end; gap:6px; pointer-events:none}
    .sideclock .time{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:56px; letter-spacing:2px; text-shadow:0 0 20px rgba(60,245,255,.55), 0 0 60px rgba(60,245,255,.25)}
    .sideclock .date{font-size:12px; color:#9bb2bb; letter-spacing:2px; text-transform:uppercase}
    .sideclock .bar{width:220px; height:3px; background:linear-gradient(90deg, var(--accent), transparent); box-shadow:0 0 10px rgba(60,245,255,.5)}

    /* Small */
    @media (max-width: 1000px){
      .panel{left:24px; right:24px; width:auto; top:auto; bottom:24px}
      .branches{bottom:210px}
      .langs{bottom:210px}
      .sideclock{right:18px}
    }
  </style>
</head>
<body>
  <div class="hud" role="application" aria-label="Prototipo HUD con reconocimiento de voz y selecci√≥n de almac√©n">
    <div class="topbar">
      <div class="brand">HUD ¬∑ Prototipo</div>
      <div class="datetime" id="datetime">--:--</div>
    </div>

    <!-- Centro: esfera con ecualizador circular -->
    <div class="core">
      <div class="wrap" id="coreWrap" aria-label="Esfera de micr√≥fono: pulsa para activar o detener.">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <defs>
            <radialGradient id="g" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#0cf"/>
              <stop offset="50%" stop-color="#0cf" stop-opacity=".6"/>
              <stop offset="100%" stop-color="#0cf" stop-opacity="0"/>
            </radialGradient>
          </defs>
          <circle cx="50" cy="50" r="40" fill="url(#g)" opacity=".15" />

          <!-- Ticks base -->
          <g class="ticks">
            <circle cx="50" cy="50" r="16" fill="none" stroke="#36f3ff" stroke-width="0.6" stroke-dasharray=".8 1.6"/>
            <circle cx="50" cy="50" r="8" fill="#061116" stroke="#36f3ff" stroke-width="0.6"/>
          </g>

          <!-- Anillo exterior fino -->
          <g class="ring">
            <circle class="pulse" id="ringOuter" cx="50" cy="50" r="33.5" fill="none" stroke="#36f3ff" stroke-width="0.8" />
          </g>

          <!-- Equalizador circular -->
          <g id="bars" stroke="#36f3ff" fill="#36f3ff"></g>
        </svg>
        <button class="mic-btn" id="micBtn" aria-label="Alternar micr√≥fono"></button>
      </div>
    </div>

    <!-- Saludo -->
    <div class="greet" id="greet">Hola üëã<small>Pulsa en la esfera para hablar</small></div>

    <!-- Almacenes -->
    <div class="branches" aria-label="Selecciona un almac√©n">
      <div class="branch"><div class="line"></div><button data-store="Coll">Coll</button></div>
      <div class="branch"><div class="line"></div><button data-store="Calvi√†">Calvi√†</button></div>
      <div class="branch"><div class="line"></div><button data-store="Alcudia">Alcudia</button></div>
      <div class="branch"><div class="line"></div><button data-store="Santany√≠">Santany√≠</button></div>
    </div>

    <!-- Idiomas -->
    <div class="langs" aria-label="Selecciona idioma">
      <p class="title">Idiomas</p>
      <div class="branch"><button data-lang="es-ES">Espa√±ol</button><div class="line"></div></div>
      <div class="branch"><button data-lang="ca-ES">Catal√† (Mallorqu√≠)</button><div class="line"></div></div>
      <div class="branch"><button data-lang="en-US">English</button><div class="line"></div></div>
      <div class="branch"><button data-lang="de-DE">Deutsch</button><div class="line"></div></div>
      <div class="branch"><button data-lang="pl-PL">Polski</button><div class="line"></div></div>
      <div class="branch"><button data-lang="ru-RU">–†—É—Å—Å–∫–∏–π</button><div class="line"></div></div>
    </div>

    <!-- Panel transcripci√≥n -->
    <div class="panel" aria-live="polite">
      <h3>Transcripci√≥n</h3>
      <div class="bubble" id="transcript">(esperando‚Ä¶)</div>
    </div>

    <!-- Estado -->
    <div class="status" id="status"><div class="led"></div><span>Micr√≥fono inactivo</span></div>

    <!-- Reloj lateral -->
    <div class="sideclock" aria-hidden="true">
      <div class="time" id="sideTime">00:00</div>
      <div class="bar" id="secBar"></div>
      <div class="date" id="sideDate">--</div>
    </div>
  </div>

  <script>
  // Fecha/Hora superior + lateral
  const fmtTop = new Intl.DateTimeFormat('es-ES',{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
  const dtTop = document.getElementById('datetime');
  const sideTime = document.getElementById('sideTime');
  const sideDate = document.getElementById('sideDate');
  const secBar = document.getElementById('secBar');
  function clockTick(){
    const now = new Date();
    dtTop.textContent = fmtTop.format(now);
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = now.getSeconds();
    sideTime.textContent = `${hh}:${mm}`;
    sideDate.textContent = new Intl.DateTimeFormat('es-ES',{weekday:'long', day:'2-digit', month:'long'}).format(now);
    const p = (ss/60); // 0..1
    secBar.style.background = `linear-gradient(90deg, var(--accent) ${Math.round(p*100)}%, rgba(60,245,255,0.1) ${Math.round(p*100)}%)`;
  }
  setInterval(clockTick, 1000); clockTick();

  // Saludo por voz (opcional)
  function speak(text, lang='es-ES'){ try{ const u = new SpeechSynthesisUtterance(text); u.lang=lang; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

  // UI refs
  const micBtn = document.getElementById('micBtn');
  const statusEl = document.getElementById('status');
  const transcriptEl = document.getElementById('transcript');
  const ringOuter = document.getElementById('ringOuter');
  const greetEl = document.getElementById('greet');
  const barsG = document.getElementById('bars');

  // Idioma actual
  let currentLang = 'es-ES';

  // Almacenes
  document.querySelectorAll('[data-store]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const store = btn.dataset.store;
      greetEl.innerHTML = `Almac√©n seleccionado: <b>${store}</b><small>Di "buscar" para empezar o usa el micr√≥fono.</small>`;
      speak(`Has seleccionado ${store}`, currentLang);
    })
  })

  // Idiomas
  document.querySelectorAll('[data-lang]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentLang = btn.dataset.lang;
      greetEl.innerHTML = `Idioma: <b>${btn.textContent}</b><small>La transcripci√≥n y la voz usar√°n este idioma.</small>`;
      speak('Idioma actualizado', currentLang);
      if(recognition){ recognition.lang = currentLang; }
    })
  })

  // Reconocimiento de voz
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null; let isListening = false;

  // Visualizaci√≥n con ecualizador circular
  let audioCtx, analyser, freqArray, mediaStream, rafId;

  // Crear barras en SVG
  const BAR_COUNT = 48; const R_IN = 26; const R_OUT = 34;
  for(let i=0;i<BAR_COUNT;i++){
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('class','bar');
    const angle = (i/BAR_COUNT)*360;
    g.setAttribute('transform', `translate(50,50) rotate(${angle})`);
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', -0.6);
    rect.setAttribute('y', -R_OUT);
    rect.setAttribute('width', 1.2);
    rect.setAttribute('height', R_OUT-R_IN);
    rect.setAttribute('rx', 0.8);
    rect.setAttribute('fill', '#36f3ff');
    rect.setAttribute('opacity', '0.55');
    g.appendChild(rect);
    barsG.appendChild(g);
  }

  const rects = Array.from(barsG.querySelectorAll('rect'));

  function setMicActive(active){
    isListening = active;
    statusEl.classList.toggle('active', active);
    statusEl.lastElementChild.textContent = active ? 'Micr√≥fono activo' : 'Micr√≥fono inactivo';
  }

  function startVis(stream){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    freqArray = new Uint8Array(analyser.frequencyBinCount);
    const source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);

    function loop(){
      analyser.getByteFrequencyData(freqArray);
      const group = Math.floor(freqArray.length / BAR_COUNT);
      for(let i=0;i<BAR_COUNT;i++){
        let sum=0; for(let j=0;j<group;j++){ sum += freqArray[i*group + j]; }
        const v = sum/(group*255); // 0..1
        const len = (R_OUT-R_IN)*(0.25 + v*0.9); // longitudes
        const y = -R_OUT;
        rects[i].setAttribute('y', y);
        rects[i].setAttribute('height', Math.max(2, len));
        rects[i].setAttribute('opacity', 0.35 + v*0.7);
      }
      ringOuter.style.transform = `scale(${1 + Math.min(0.3, (freqArray[5]||0)/255 * 0.3)})`;
      rafId = requestAnimationFrame(loop);
    }
    loop();
  }

  async function startListening(){
    if(!SR){ transcriptEl.textContent = 'Reconocimiento de voz no disponible en este navegador.'; return; }

    // getUserMedia primero para la visual
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
      startVis(mediaStream);
    }catch(e){ transcriptEl.textContent = 'Permiso de micr√≥fono denegado.'; return; }

    recognition = new SR();
    recognition.lang = currentLang;
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onresult = (ev)=>{
      let final = ''; let interim = '';
      for(let i=ev.resultIndex; i<ev.results.length; i++){
        const res = ev.results[i];
        if(res.isFinal) final += res[0].transcript + ' ';
        else interim += res[0].transcript;
      }
      transcriptEl.textContent = (final + interim).trim();
    }

    recognition.onend = ()=>{ stopListening(); }
    recognition.onerror = ()=>{ stopListening(); }

    recognition.start();
    setMicActive(true);
    speak('Escuchando', currentLang);
  }

  function stopListening(){
    try{ recognition && recognition.stop(); }catch{}
    try{ if(rafId) cancelAnimationFrame(rafId); }catch{}
    try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch{}
    try{ audioCtx && audioCtx.close(); }catch{}
    setMicActive(false);
    ringOuter.style.transform = 'scale(1)';
  }

  document.getElementById('micBtn').addEventListener('click', ()=>{
    if(isListening) stopListening(); else startListening();
  });

  // Mensaje inicial
  greetEl.firstChild && (greetEl.firstChild.textContent = 'Hola, bienvenido');
  try{ if(location.protocol === 'http:' && location.hostname !== 'localhost'){ console.warn('Para el micr√≥fono se requiere HTTPS. GitHub Pages funciona.'); }
  }catch{}
  </script>
</body>
</html>
