<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Jarvis ¬∑ Kiosk Duran</title>
<link rel="icon" href="logo-duran.png"/>
<!-- Librer√≠a para leer EXCEL en el navegador (gratuita) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#0b1324; --bg2:#0e1a35; --ink:#e6efff; --mut:#a9b7e6; --glass:rgba(255,255,255,.06);
  --line:rgba(255,255,255,.12); --brand:#57a3ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1100px 600px at 50% -10%, #1a3a78 0%, #0e1a35 50%, #091326 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;color:var(--ink)}
.app{min-height:100%;display:grid;grid-template-rows:auto 1fr}
header{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:14px 16px}
.logo{display:flex;align-items:center;gap:12px;position:relative}
.logo img{height:38px;filter:drop-shadow(0 2px 18px rgba(87,163,255,.35))}
.logo .halo{position:absolute;left:-6px;top:-6px;width:70px;height:70px;border-radius:50%;background:radial-gradient(circle at 35% 30%, rgba(87,163,255,.28), rgba(87,163,255,.05) 60%, transparent 65%);pointer-events:none}
.badge{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--glass);color:var(--ink);font-weight:600}
.small{font-size:12px;color:var(--mut)}
.grid{display:grid;gap:16px}
.two{grid-template-columns:1.15fr .85fr}
.card{border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));backdrop-filter:blur(10px);border-radius:18px;padding:16px}
.row{display:flex;gap:10px;align-items:center}
input,button,select{font:inherit}
input[type="text"], input[type="number"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.2);color:var(--ink);outline:none}
button{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.08);color:var(--ink);cursor:pointer}
button:hover{background:rgba(255,255,255,.12)}
button.ghost{background:transparent;border-color:transparent;color:var(--mut)}
.btn-brand{border-color:rgba(87,163,255,.5);box-shadow:0 0 0 3px rgba(87,163,255,.12) inset}
.flags{display:grid;grid-template-columns:repeat(6,52px);gap:8px}
.flags button{padding:0;border-radius:10px;overflow:hidden}
.flags img{display:block;width:100%;height:40px;object-fit:cover}
.sphere{width:160px;height:160px;border-radius:50%;margin:auto;border:1px solid rgba(255,255,255,.25);box-shadow:0 0 40px rgba(80,180,255,.28);position:relative;overflow:hidden}
.sphere .g{position:absolute;inset:0;background:conic-gradient(from 0deg at 50% 50%, #60a5fa, #a78bfa, #f472b6, #60a5fa);filter:blur(16px);opacity:.85}
.sphere.listening .g{animation:rot 8s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}
.sphere .ring{position:absolute;left:50%;top:50%;width:90px;height:90px;transform:translate(-50%,-50%);border-radius:50%;border:1px solid rgba(255,255,255,.45);opacity:.5}
.sphere.listening .ring{animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:.6}50%{transform:translate(-50%,-50%) scale(1.5);opacity:.1}100%{transform:translate(-50%,-50%) scale(1);opacity:.6}}
.list{display:grid;gap:10px;max-height:48vh;overflow:auto}
.item{display:grid;gap:6px;border:1px solid var(--line);background:rgba(255,255,255,.04);padding:12px;border-radius:14px}
.sub{color:var(--mut);font-size:12px}
.hidden{display:none!important}
/* Mapa */
.map{position:relative;border:1px solid var(--line);border-radius:16px;overflow:hidden}
.map img{display:block;width:100%;height:auto;user-select:none}
.pin{position:absolute;width:14px;height:14px;background:#ef4444;border-radius:50%;box-shadow:0 0 0 5px rgba(239,68,68,.35);transform:translate(-50%,-50%);display:none}
.grid-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
footer{padding:8px 16px;color:var(--mut);font-size:12px}
.bad{color:#fca5a5}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="halo"></div>
      <img src="logo-duran.png" alt="DURAN"/>
      <div class="badge">Jarvis ¬∑ Centro Duran Calvi√†</div>
    </div>
    <div class="row small">
      <span id="status">Listo</span>
      <button id="adminToggle" class="ghost" title="Modo administrador">‚öôÔ∏è Admin</button>
    </div>
  </header>

  <main class="grid two" style="padding:16px">
    <!-- COLUMNA IZQUIERDA: idioma, consulta, resultados, import/export -->
    <section class="card grid" id="left">
      <div class="grid">
        <div class="small">Selecciona idioma</div>
        <div class="flags" id="flags"></div>
      </div>
      <div class="row">
        <input id="name" type="text" placeholder="Tu nombre (opcional)"/>
        <button id="start" class="btn-brand">Empezar</button>
      </div>

      <div class="grid" id="queryBox" style="display:none">
        <div class="row">
          <input id="q" type="text" placeholder="Escribe lo que necesitas‚Ä¶ (ej. manguito 32, scala2, filtro e1)"/>
          <button id="mic" title="Hablar">üéôÔ∏è</button>
          <button id="go" class="btn-brand">Buscar</button>
        </div>
        <div class="grid" style="place-items:center">
          <div class="sphere" id="sphere"><div class="g"></div><div class="ring"></div></div>
          <div id="spLabel" class="small">Listo</div>
        </div>
      </div>

      <div id="results" class="list hidden"></div>

      <details>
        <summary class="small">üì• Importar datos (EXCEL/CSV) ¬∑ üì§ Exportar</summary>
        <div class="grid">
          <div class="row">
            <input type="file" id="inpExcel" accept=".xlsx,.xls"/>
            <button id="btnExcel" title="Leer Excel y preparar art√≠culos">Importar Excel</button>
            <button id="expArt">Exportar Articulos.csv</button>
          </div>
          <div class="row">
            <input type="file" id="inpUbiCSV" accept=".csv"/>
            <button id="impUbi">Importar Ubicaciones.csv</button>
            <button id="expUbi">Exportar Ubicaciones.csv</button>
          </div>
        </div>
      </details>
    </section>

    <!-- COLUMNA DERECHA: MAPA (se muestra SOLO cuando hay selecci√≥n) -->
    <section class="card grid hidden" id="right">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="small">Plano (aparece tras localizar el producto)</div>
        <button id="again" class="ghost">‚Ü©Ô∏é Nueva b√∫squeda</button>
      </div>
      <div class="map" id="mapBox">
        <img id="mapImg" src="plano-calvia.jpg" alt="Plano Calvi√†"/>
        <div id="pin" class="pin"></div>
      </div>
      <div id="route" class="sub"></div>

      <!-- Panel Admin para fijar ubicaci√≥n -->
      <div id="adminPanel" class="hidden">
        <div class="small">Modo administrador ¬∑ Toca el plano para capturar X/Y (0‚Äì1). Completa los campos y pulsa Guardar.</div>
        <div class="grid-two">
          <label>Pasillo <input id="fPasillo" type="number" min="0" step="1"></label>
          <label>Lado
            <select id="fLado">
              <option value="I">I</option>
              <option value="D">D</option>
            </select>
          </label>
          <label>Estante <input id="fEst" type="number" min="0" step="1"></label>
          <label>Balda <input id="fBal" type="number" min="0" step="1"></label>
          <label>X <input id="fX" type="number" min="0" max="1" step="0.01"></label>
          <label>Y <input id="fY" type="number" min="0" max="1" step="0.01"></label>
        </div>
        <div class="row">
          <button id="saveLoc" class="btn-brand">üíæ Guardar ubicaci√≥n del art√≠culo seleccionado</button>
          <button id="delLoc">üóëÔ∏è Quitar ubicaci√≥n</button>
        </div>
        <div class="small">Las ubicaciones quedan en memoria y puedes <strong>Exportar Ubicaciones.csv</strong> para subirlo a tu hosting.</div>
      </div>
    </section>
  </main>

  <footer>Funciona offline como PWA. Datos desde CSV o importando Excel (luego exporta CSV). Voz gratis (Web Speech API). ¬© DURAN</footer>
</div>

<script>
// =============== Config ===============
const CENTER = "Duran Calvi√†"; // Centro por defecto
const LANGS = {
  es:{name:"Espa√±ol", tag:"es-ES", sphere:{idle:"Listo", listening:"Escuchando‚Ä¶", thinking:"Pensando‚Ä¶", speaking:"Hablando‚Ä¶"},
      explainIntro:n=>`${n? n+", ":""}Te explico y te gu√≠o.`,
      found:d=>`He encontrado la mejor opci√≥n: ${d}.`,
      guide:(p,l,e,b)=>`Desde tu posici√≥n, dir√≠gete al pasillo ${p}, lado ${l}, estante ${e}, balda ${b}.`},
  ca:{name:"Mallorqu√≠", tag:"ca-ES", sphere:{idle:"A punt", listening:"Escoltant‚Ä¶", thinking:"Pensant‚Ä¶", speaking:"Parlant‚Ä¶"},
      explainIntro:n=>`${n? n+", ":""}T'ho explic i despr√©s te guiar√©.`,
      found:d=>`La millor opci√≥ √©s: ${d}.`,
      guide:(p,l,e,b)=>`Des de la teva ubicaci√≥, ves al passad√≠s ${p}, costat ${l}, prestatge ${e}, balda ${b}.`},
  en:{name:"English", tag:"en-GB", sphere:{idle:"Ready", listening:"Listening‚Ä¶", thinking:"Thinking‚Ä¶", speaking:"Speaking‚Ä¶"},
      explainIntro:n=>`${n? n+", ":""}I'll explain and guide you.`,
      found:d=>`Best match: ${d}.`,
      guide:(p,l,e,b)=>`From your position, go to aisle ${p}, ${l} side, shelf ${e}, tier ${b}.`},
  de:{name:"Deutsch", tag:"de-DE", sphere:{idle:"Bereit", listening:"Zuh√∂ren‚Ä¶", thinking:"Denken‚Ä¶", speaking:"Sprechen‚Ä¶"},
      explainIntro:n=>`${n? n+", ":""}Ich erkl√§re kurz und f√ºhre Sie.`,
      found:d=>`Beste Option: ${d}.`,
      guide:(p,l,e,b)=>`Von Ihrer Position zum Gang ${p}, ${l}e Seite, Regal ${e}, Ebene ${b}.`},
  pl:{name:"Polski", tag:"pl-PL", sphere:{idle:"Gotowe", listening:"S≈Çucham‚Ä¶", thinking:"My≈õlƒô‚Ä¶", speaking:"M√≥wiƒô‚Ä¶"},
      explainIntro:n=>`${n? n+", ":""}Kr√≥tko wyja≈õniƒô i poprowadzƒô.`,
      found:d=>`Najlepsza opcja: ${d}.`,
      guide:(p,l,e,b)=>`Z Twojej pozycji: alejka ${p}, strona ${l}, p√≥≈Çka ${e}, poziom ${b}.`},
  ru:{name:"–†—É—Å—Å–∫–∏–π", tag:"ru-RU", sphere:{idle:"–ì–æ—Ç–æ–≤–æ", listening:"–°–ª—É—à–∞—é‚Ä¶", thinking:"–î—É–º–∞—é‚Ä¶", speaking:"–ì–æ–≤–æ—Ä—é‚Ä¶"},
      explainIntro:n=>`${n? n+", ":""}–ö–æ—Ä–æ—Ç–∫–æ –æ–±—ä—è—Å–Ω—é –∏ –ø—Ä–æ–≤–µ–¥—É.`,
      found:d=>`–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç: ${d}.`,
      guide:(p,l,e,b)=>`–û—Ç –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏: —Ä—è–¥ ${p}, —Å—Ç–æ—Ä–æ–Ω–∞ ${l}, –ø–æ–ª–∫–∞ ${e}, —É—Ä–æ–≤–µ–Ω—å ${b}.`}
};
let lang='es', admin=false;

// =============== UI refs ===============
const flags=document.getElementById('flags');
const nameInput=document.getElementById('name');
const startBtn=document.getElementById('start');
const queryBox=document.getElementById('queryBox');
const q=document.getElementById('q');
const goBtn=document.getElementById('go');
const micBtn=document.getElementById('mic');
const sphere=document.getElementById('sphere');
const spLabel=document.getElementById('spLabel');
const statusEl=document.getElementById('status');
const resultsEl=document.getElementById('results');
const right=document.getElementById('right');
const mapImg=document.getElementById('mapImg');
const mapBox=document.getElementById('mapBox');
const pin=document.getElementById('pin');
const routeEl=document.getElementById('route');
const againBtn=document.getElementById('again');
const adminToggle=document.getElementById('adminToggle');
const adminPanel=document.getElementById('adminPanel');
const fPas=document.getElementById('fPasillo');
const fLado=document.getElementById('fLado');
const fEst=document.getElementById('fEst');
const fBal=document.getElementById('fBal');
const fX=document.getElementById('fX');
const fY=document.getElementById('fY');
const saveLocBtn=document.getElementById('saveLoc');
const delLocBtn=document.getElementById('delLoc');

// Import/Export
const inpExcel=document.getElementById('inpExcel');
const btnExcel=document.getElementById('btnExcel');
const expArt=document.getElementById('expArt');
const inpUbiCSV=document.getElementById('inpUbiCSV');
const impUbi=document.getElementById('impUbi');
const expUbi=document.getElementById('expUbi');

// =============== Flags ===============
const SENYERA = `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='640' height='400'><rect width='640' height='400' fill='#f7d117'/><g fill='#d40000'><rect y='25' width='640' height='50'/><rect y='115' width='640' height='50'/><rect y='205' width='640' height='50'/><rect y='295' width='640' height='50'/></g></svg>`)}`;
const FLAGS={es:'https://flagcdn.com/w80/es.png', ca:SENYERA, en:'https://flagcdn.com/w80/gb.png', de:'https://flagcdn.com/w80/de.png', pl:'https://flagcdn.com/w80/pl.png', ru:'https://flagcdn.com/w80/ru.png'};
for(const code of Object.keys(LANGS)){
  const b=document.createElement('button'); b.innerHTML=`<img alt='${code}' src='${FLAGS[code]}'/>`; b.title=LANGS[code].name; b.onclick=()=>{lang=code; setSphere('idle'); speak(`Idioma ${LANGS[code].name}`)}; flags.appendChild(b);
}

// =============== Speech (gratis) ===============
let VOICES=[]; function refreshVoices(){try{VOICES=speechSynthesis.getVoices()}catch{}}; refreshVoices(); speechSynthesis.onvoiceschanged=refreshVoices;
function pickVoice(tag){tag=tag.toLowerCase(); const pool=VOICES.filter(v=> (v.lang||'').toLowerCase().startsWith(tag.slice(0,2)) || (v.lang||'').toLowerCase()===tag); const score=v=>{let s=0; const n=(v.name||'').toLowerCase(); if((v.lang||'').toLowerCase().startsWith(tag)) s+=5; if(n.includes('google')||n.includes('microsoft')) s+=3; if(n.includes('natural')||n.includes('neural')) s+=2; return s}; return pool.sort((a,b)=>score(b)-score(a))[0]||pool[0]||null}
function speak(text){try{const u=new SpeechSynthesisUtterance(text); const v=pickVoice(LANGS[lang].tag)||pickVoice('es-ES'); if(v) u.voice=v; u.lang=(v&&v.lang)||LANGS[lang].tag; u.rate=1; u.pitch=1; u.volume=1; speechSynthesis.cancel(); speechSynthesis.speak(u); setSphere('speaking'); const ms=Math.min(7000, Math.max(1400, text.split(/\s+/).length*350)); setTimeout(()=>setSphere('idle'), ms);}catch(e){console.warn(e)}}
let rec=null, listening=false, recStart=0; function startListening(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ alert('El navegador no soporta reconocimiento de voz'); return } rec=new SR(); rec.lang=LANGS[lang].tag; rec.continuous=true; rec.interimResults=true; rec.onresult=(ev)=>{let txt=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ const r=ev.results[i]; if(r.isFinal) txt+=r[0].transcript+' ' } if(txt.trim()){ q.value=(q.value? q.value+' ':'')+txt.trim(); handleSearch() }}; rec.onend=()=>{ if(!listening){ setSphere('idle'); return } const elapsed=Date.now()-recStart; if(elapsed<8000){ rec.start() } else { listening=false; setSphere('idle') } }; listening=true; recStart=Date.now(); setSphere('listening'); rec.start() }
function stopListening(){try{listening=false; rec&&rec.stop()}catch{}}
function setSphere(mode){sphere.classList.remove('listening','speaking'); if(mode==='listening') sphere.classList.add('listening'); if(mode==='speaking') sphere.classList.add('speaking'); spLabel.textContent=LANGS[lang].sphere[mode]||'‚Ä¶'; statusEl.textContent=spLabel.textContent}

// =============== Datos ===============
let ART=[], UBI=[], INDEX={}; let varSel=null;
function normalize(s){return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}
const SYN=[['grupo de presion','grupo presion','grupo presi√≥n','presurizador','booster','hidrofor','estacion presion','estaci√≥n presi√≥n'],['bomba','electrobomba','impulsor','scala','prisma'],['manguito','acople','acoplamiento','union','uni√≥n','enchufe','conector','racor'],['valvula','v√°lvula','esfera','llave'],['tubo','tuberia','tuber√≠a','pe','polietileno','pvc','multicapa'],['codo','coud√©','coude'],['te','tee','derivacion','derivaci√≥n'],['filtro','filtros','e1'],['descalcificador','descalcificador myperla','myperla','bwt']];
function expandSyn(q){let s=normalize(q); for(const g of SYN){ for(const w of g){ if(s.includes(normalize(w))){ s+=' '+g.join(' ') } } } return s}
function parseNum(v){ if(v==null) return null; if(typeof v==='number') return v; const s=String(v).trim().replace(',','.'); const n=Number(s); return isFinite(n)? n : null }

async function fetchText(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return null; return await r.text()}catch{ return null}}
function parseCSV(text){ const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length); const sep=(lines[0].match(/;/g)||[]).length > (lines[0].match(/,/g)||[]).length? ';' : ','; const rows=[]; for(const line of lines){ rows.push(parseCSVLine(line,sep)) } const headers=rows.shift().map(h=>h.trim()); return rows.map(r=>{const o={}; headers.forEach((h,i)=> o[h]=(r[i]??'').trim()); return o}) }
function parseCSVLine(line,sep){ const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ } } else if(ch===sep && !inQ){ out.push(cur); cur='' } else { cur+=ch } } out.push(cur); return out }

async function loadData(){
  const a=await fetchText('Articulos.csv'); if(a){ ART=parseCSV(a) } else { ART=[] }
  const u=await fetchText('Ubicaciones.csv'); if(u){ UBI=parseCSV(u) } else { UBI=[] }
  reindex();
}
function reindex(){ // filtra por centro y crea mapa por NumeroArticulo
  const only=UBI.filter(u=> (u.Centro===CENTER || u.Centro==='Calvia')); const map=new Map(); for(const u of only){ const k=(u.NumeroArticulo||'').toString().trim(); if(!map.has(k)) map.set(k,[]); map.get(k).push(u) } INDEX=Object.fromEntries(map)
}
function pickLocation(num){ const list=INDEX[(num||'').toString().trim()]; if(!list||!list.length) return null; return list.slice().sort((a,b)=> Number(b.Stock||0)-Number(a.Stock||0))[0] }

function search(qraw){ const qn=expandSyn(qraw); const words=normalize(qn).split(/\s+/).filter(Boolean); const scored=[]; for(const a of ART){ const text=normalize(`${a.Descripcion} ${a.ReferenciaProveedor} ${a.CodigoEAN}`); let s=0; for(const w of words){ if(!w) continue; if(text.includes(w)) s+=2; if(text.startsWith(w)) s+=1 } if(s>0){ scored.push({a,score:s}) } } scored.sort((x,y)=>y.score-x.score); return scored.slice(0,50).map(x=>x.a) }

function renderResults(list){ resultsEl.innerHTML=''; if(!list.length){ const div=document.createElement('div'); div.className='item'; div.innerHTML='<div>No se han encontrado art√≠culos. Por favor, solicite ayuda a un vendedor.</div>'; resultsEl.appendChild(div); resultsEl.classList.remove('hidden'); right.classList.add('hidden'); return }
  for(const a of list){ const loc=pickLocation(a.NumeroArticulo); const sub=`Ref: ${a.ReferenciaProveedor||'‚Äî'} ¬∑ EAN: ${a.CodigoEAN||'‚Äî'} ¬∑ Proveedor: ${a.NombreProveedor||'‚Äî'} ¬∑ Stock: ${(loc&&loc.Stock)||'‚Äî'}`; const card=document.createElement('div'); card.className='item'; card.innerHTML=`<div><strong>${a.Descripcion||'Sin descripci√≥n'}</strong></div><div class='sub'>${sub}</div><div class='row'><button class='goMap btn-brand'>Gu√≠ame</button> <button class='say'>Explicar</button></div>`; card.querySelector('.goMap').onclick=()=> selectArticle(a); card.querySelector('.say').onclick=()=> explainArticle(a); resultsEl.appendChild(card) }
  resultsEl.classList.remove('hidden'); right.classList.add('hidden');
}

function explainArticle(a){ const name=nameInput.value||''; const intro=LANGS[lang].explainIntro(name); const desc=a.Descripcion||''; speak(`${intro} ${desc}`.trim()) }

function selectArticle(a){ varSel=a; // mostrar panel mapa solo ahora
  right.classList.remove('hidden');
  const loc=pickLocation(a.NumeroArticulo); if(!loc){ speak('No tengo ubicaci√≥n registrada. Puedes capturarla en modo administrador.'); routeEl.textContent=''; pin.style.display='none'; if(admin) adminPanel.classList.remove('hidden'); return }
  // pintar pin
  const x=parseNum(loc.X), y=parseNum(loc.Y); if(x==null||y==null){ pin.style.display='none' } else { pin.style.left=(x*100)+'%'; pin.style.top=(y*100)+'%'; pin.style.display='block' }
  const lado=(loc.Lado && (loc.Lado.Value||loc.Lado)) || loc.Lado || '‚Äî';
  routeEl.textContent=LANGS[lang].guide(loc.Pasillo||'‚Äî', lado, loc.Estante||'‚Äî', loc.Balda||'‚Äî');
  speak(LANGS[lang].found(a.Descripcion||'')); setTimeout(()=> speak(routeEl.textContent), 1100)
  if(admin){ // precarga form
    fPas.value=loc.Pasillo||''; fLado.value=(lado||'I').toString().substring(0,1).toUpperCase(); fEst.value=loc.Estante||''; fBal.value=loc.Balda||''; fX.value=(x??''); fY.value=(y??''); adminPanel.classList.remove('hidden') }
}

// =============== Admin: capturar en plano y guardar ===============
mapBox.addEventListener('click', ev=>{ if(!admin || !varSel) return; const rect=mapImg.getBoundingClientRect(); const x=(ev.clientX-rect.left)/rect.width; const y=(ev.clientY-rect.top)/rect.height; fX.value=x.toFixed(2); fY.value=y.toFixed(2); pin.style.left=(x*100)+'%'; pin.style.top=(y*100)+'%'; pin.style.display='block' });

saveLocBtn.onclick=()=>{ if(!varSel) { alert('Selecciona un art√≠culo en la lista de resultados.'); return } const num=(varSel.NumeroArticulo||'').toString().trim(); const rec={ NumeroArticulo:num, Centro:CENTER, Pasillo:fPas.value||'', Lado:fLado.value||'', Estante:fEst.value||'', Balda:fBal.value||'', X:fX.value||'', Y:fY.value||'', Stock: (pickLocation(num)?.Stock||'') }; // inserta/actualiza
  const idx=UBI.findIndex(u=> (u.NumeroArticulo||'').toString().trim()===num && (u.Centro===CENTER||u.Centro==='Calvia')); if(idx>=0) UBI[idx]=rec; else UBI.push(rec); reindex(); speak('Ubicaci√≥n guardada. No olvides exportar Ubicaciones punto CSV.'); selectArticle(varSel) };

delLocBtn.onclick=()=>{ if(!varSel) return; const num=(varSel.NumeroArticulo||'').toString().trim(); const before=UBI.length; UBI=UBI.filter(u=> (u.NumeroArticulo||'').toString().trim()!==num || !(u.Centro===CENTER || u.Centro==='Calvia')); reindex(); if(UBI.length<before){ speak('Ubicaci√≥n eliminada.'); routeEl.textContent=''; pin.style.display='none' } };

// =============== Import / Export ===============
btnExcel.onclick=()=>{ const f=inpExcel.files?.[0]; if(!f){ alert('Selecciona un archivo Excel'); return } const reader=new FileReader(); reader.onload=e=>{ const wb=XLSX.read(new Uint8Array(e.target.result), {type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(ws, {defval:'', raw:false}); // mapeo de columnas
    const mapRow=r=>({
      NumeroArticulo: r.NumeroArticulo||r.numeroArticulo||r.Numero||r['N√∫mero']||r['N¬∫']||'',
      ReferenciaProveedor: r.ReferenciaProveedor||r['Referencia Proveedor']||r.Ref||'',
      Descripcion: r.Descripcion||r['Descripci√≥n']||r.Description||'',
      CodigoEAN: r.CodigoEAN||r.EAN||r.Codigo||r.C√≥digo||'',
      NombreProveedor: r.NombreProveedor||r.Proveedor||'',
      ImagenURL: r.ImagenURL||r.Imagen||'',
      FichaTecnica: r.FichaTecnica||r['Ficha T√©cnica']||'',
      Manual: r.Manual||''
    });
    ART=rows.map(mapRow).filter(r=> r.Descripcion||r.ReferenciaProveedor||r.CodigoEAN); renderResults([]); alert('Excel importado. Ya puedes buscar y exportar Articulos.csv'); };
  reader.readAsArrayBuffer(f) };

impUbi.onclick=async()=>{ const f=inpUbiCSV.files?.[0]; if(!f){ alert('Selecciona Ubicaciones.csv'); return } const text=await f.text(); UBI=parseCSV(text); reindex(); alert('Ubicaciones cargadas'); };

function download(name, text){ const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 1000) }

expArt.onclick=()=>{ if(!ART.length){ alert('No hay art√≠culos en memoria'); return } const head=['NumeroArticulo','ReferenciaProveedor','Descripcion','CodigoEAN','NombreProveedor','ImagenURL','FichaTecnica','Manual']; const lines=[head.join(';')]; for(const a of ART){ lines.push(head.map(h=> String(a[h]??'').replaceAll('"','""')).map(v=>(/[,;"\n]/.test(v)? '"'+v+'"' : v)).join(';')) } download('Articulos.csv', lines.join('\n')) };

expUbi.onclick=()=>{ if(!UBI.length){ alert('No hay ubicaciones en memoria'); return } const head=['NumeroArticulo','Centro','Pasillo','Lado','Estante','Balda','X','Y','Stock']; const lines=[head.join(';')]; for(const u of UBI){ lines.push(head.map(h=> String(u[h]??'').replaceAll('"','""')).map(v=>(/[,;"\n]/.test(v)? '"'+v+'"' : v)).join(';')) } download('Ubicaciones.csv', lines.join('\n')) };

// =============== Interacci√≥n ===============
startBtn.onclick=()=>{ queryBox.style.display='grid'; resultsEl.classList.add('hidden'); right.classList.add('hidden'); speak(LANGS[lang].explainIntro(nameInput.value||'')) };
micBtn.onclick=()=> startListening();
goBtn.onclick=()=> handleSearch();
q.onkeydown=(e)=>{ if(e.key==='Enter') handleSearch() };
againBtn.onclick=()=>{ q.value=''; resultsEl.classList.add('hidden'); right.classList.add('hidden'); routeEl.textContent=''; pin.style.display='none'; window.scrollTo(0,0) };

adminToggle.onclick=()=>{ admin=!admin; adminToggle.classList.toggle('btn-brand', admin); adminPanel.classList.toggle('hidden', !admin); if(admin && varSel){ selectArticle(varSel) } };

function handleSearch(){ stopListening(); setSphere('thinking'); const list=search(q.value||''); renderResults(list); setSphere('idle'); if(list.length){ const first=list[0]; speak(LANGS[lang].found(first.Descripcion||'')) } }

// =============== Init + PWA ===============
(async function(){ await loadData(); speak('Hola. Selecciona idioma, escribe o usa el micr√≥fono. El plano aparecer√° cuando elijamos producto.'); })();

if('serviceWorker' in navigator){ const swCode=`self.addEventListener('install',e=>{e.waitUntil(caches.open('jarvis-kiosk-v2').then(c=>c.addAll([location.href]))) }); self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`; const blob=new Blob([swCode],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url).catch(()=>{}); }
</script>
</body>
</html>

