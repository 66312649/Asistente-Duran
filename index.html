<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Asistente Duran AI</title>
<link rel="icon" href="logo-duran.png"/>
<style>
/* CSS Variables for theming */
:root {
  --bg-primary: #0f0f23;
  --bg-secondary: #1a1a2e;
  --bg-tertiary: #16213e;
  --text-primary: #ffffff;
  --text-secondary: #b4b4b4;
  --text-muted: #6b7280;
  --accent-primary: #333333;
  --accent-secondary: #444444;
  --accent-tertiary: #555555;
  --border-color: #2d2d2d;
  --message-user: #2f2f2f;
  --message-ai: #1e1e1e;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  --border-radius: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Light mode variables */
[data-theme="light"] {
  --bg-primary: #ffffff;
  --bg-secondary: #f7f7f8;
  --bg-tertiary: #ffffff;
  --text-primary: #2d2d2d;
  --text-secondary: #4a4a4a;
  --text-muted: #6b7280;
  --accent-primary: #333333;
  --accent-secondary: #444444;
  --accent-tertiary: #555555;
  --border-color: #e5e5e5;
  --message-user: #f0f0f0;
  --message-ai: #ffffff;
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Reset and base styles */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow-x: hidden;
}

/* Main app container */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 100vw;
  position: relative;
}

/* Header with AI branding and controls */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border-color);
  padding: 1rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 70px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.logo {
  height: 40px;
  width: auto;
  filter: drop-shadow(0 2px 8px rgba(51, 51, 51, 0.3));
}

/* Header controls */
.header-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.theme-toggle {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 0.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1.2rem;
}

.theme-toggle:hover {
  background: var(--bg-tertiary);
  border-color: var(--accent-primary);
}

.center-selector {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
}

.center-selector:hover {
  border-color: var(--accent-primary);
}

/* Data counter styles */
.data-counter {
  display: flex;
  gap: 1rem;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.data-counter span {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.data-counter strong {
  color: var(--text-primary);
  font-weight: 600;
}

/* Main chat container */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  position: relative;
}

/* Chat messages area */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 2rem 1rem;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* Custom scrollbar */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: var(--accent-primary);
}

/* Message bubbles */
.message {
  display: flex;
  gap: 1rem;
  max-width: 100%;
  animation: messageSlideIn 0.3s ease-out;
  margin-bottom: 2rem;
}

.message.user {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.9rem;
  flex-shrink: 0;
}

.message.user .message-avatar {
  background: var(--accent-primary);
  color: white;
}

.message.ai .message-avatar {
  background: var(--bg-tertiary);
  border: 2px solid var(--accent-primary);
  color: var(--accent-primary);
}

.message-content {
  background: transparent;
  padding: 0;
  border-radius: 0;
  max-width: 70%;
  word-wrap: break-word;
  border: none;
  position: relative;
  color: var(--text-primary);
  line-height: 1.6;
}

.message.user .message-content {
  background: transparent;
  border: none;
  color: var(--text-primary);
}

/* Welcome message */
.welcome-message {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-secondary);
}

.welcome-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 1rem;
  background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.welcome-subtitle {
  font-size: 1.1rem;
  margin-bottom: 2rem;
  line-height: 1.6;
}

/* Language selector */
.language-selector {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.language-flag {
  width: 60px;
  height: 45px;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  overflow: hidden;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.language-flag:hover {
  border-color: var(--accent-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.language-flag.active {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
}

.language-flag img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Input area */
.input-area {
  padding: 0.75rem 2rem 1rem;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
  position: sticky;
  bottom: 0;
}

.input-container {
  max-width: 800px;
  margin: 0 auto;
  position: relative;
}

.input-wrapper {
  display: flex;
  align-items: flex-end;
  gap: 1rem;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 0.5rem;
  transition: var(--transition);
}

.input-wrapper:focus-within {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.1);
}

.message-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-size: 1rem;
  line-height: 1.5;
  resize: none;
  min-height: 24px;
  max-height: 80px;
  font-family: inherit;
}

.message-input::placeholder {
  color: var(--text-muted);
}

.input-controls {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.control-btn {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 0.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.control-btn:hover {
  background: var(--accent-primary);
  border-color: var(--accent-primary);
  color: white;
  transform: translateY(-1px);
}

.control-btn.primary {
  background: var(--accent-primary);
  border-color: var(--accent-primary);
  color: white;
}

.control-btn.primary:hover {
  background: var(--accent-secondary);
  border-color: var(--accent-secondary);
}

.control-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Voice recording indicator */
.voice-indicator {
  position: absolute;
  top: -50px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent-primary);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 25px;
  font-size: 0.9rem;
  opacity: 0;
  transition: var(--transition);
  pointer-events: none;
}

.voice-indicator.active {
  opacity: 1;
  transform: translateX(-50%) translateY(-10px);
}

.voice-indicator::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 8px solid transparent;
  border-top-color: var(--accent-primary);
}

/* Loading animation for AI responses */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem 1.5rem;
  background: var(--message-ai);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  max-width: 70%;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background: var(--accent-primary);
  border-radius: 50%;
  animation: typingBounce 1.4s ease-in-out infinite;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

/* Results and map sections (hidden by default) */
.results-section,
.map-section {
  display: none;
  padding: 2rem;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
}

.results-section.active,
.map-section.active {
  display: block;
}

.results-grid {
  display: grid;
  gap: 1rem;
  margin-top: 1rem;
}

.result-item {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  transition: var(--transition);
  cursor: pointer;
}

.result-item:hover {
  border-color: var(--accent-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.result-title {
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

.result-details {
  color: var(--text-secondary);
  font-size: 0.9rem;
  line-height: 1.4;
}

/* Map container */
.map-container {
  position: relative;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  overflow: hidden;
  height: 500px;
  background: var(--bg-tertiary);
}

.map-image {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.map-pin {
  position: absolute;
  width: 20px;
  height: 20px;
  background: #ef4444;
  border-radius: 50%;
  border: 3px solid white;
  box-shadow: var(--shadow);
  transform: translate(-50%, -50%);
  animation: pinPulse 2s ease-in-out infinite;
}

/* Animations */
@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes typingBounce {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

@keyframes pinPulse {
  0%, 100% {
    transform: translate(-50%, -50%) scale(1);
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2);
  }
}

/* Responsive design */
@media (max-width: 768px) {
  .header {
    padding: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .header-controls {
    order: 3;
    width: 100%;
    justify-content: center;
  }
  
  .chat-messages {
    padding: 1rem 0.5rem;
  }
  
  .message-content {
    max-width: 85%;
  }
  
  .input-area {
    padding: 0.5rem;
  }
  
  .welcome-message {
    padding: 2rem 1rem;
  }
  
  .welcome-title {
    font-size: 1.5rem;
  }
  
  .language-selector {
    gap: 0.5rem;
  }
  
  .language-flag {
    width: 50px;
    height: 38px;
  }
}

@media (max-width: 480px) {
  .message {
    gap: 0.5rem;
  }
  
  .message-avatar {
    width: 32px;
    height: 32px;
    font-size: 0.8rem;
  }
  
  .message-content {
    padding: 0.75rem 1rem;
    max-width: 90%;
  }
  
  .input-wrapper {
    padding: 0.5rem;
  }
  
  .control-btn {
    padding: 0.5rem;
    font-size: 1rem;
  }
}

/* Accessibility improvements */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Focus styles for keyboard navigation */
.control-btn:focus,
.theme-toggle:focus,
.center-selector:focus,
.language-flag:focus {
  outline: 2px solid var(--accent-primary);
  outline-offset: 2px;
}

.message-input:focus {
  outline: none;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --border-color: #ffffff;
    --text-secondary: #ffffff;
  }
}
</style>
</head>
<body>
<div class="app">
  <!-- Header with AI branding -->
  <header class="header">
    <div class="header-left">
      <img src="logo-duran.png" alt="DURAN" class="logo"/>
    </div>
    
    <div class="header-controls">
      <div class="data-counter" id="dataCounter">
        <span>Artículos: <strong id="articleCount">0</strong></span>
        <span>Ubicaciones: <strong id="locationCount">0</strong></span>
      </div>
      <button class="theme-toggle" id="themeToggle" title="Cambiar tema">🌙</button>
      <select class="center-selector" id="centerSelector">
        <option value="calvia">Centro Duran Calvià</option>
        <option value="coll">Centro Duran Coll</option>
        <option value="alcudia">Centro Duran Alcudia</option>
        <option value="santanyi">Centro Duran Santanyí</option>
      </select>
    </div>
  </header>

  <!-- Main chat container -->
  <div class="chat-container">
    <!-- Chat messages area -->
    <div class="chat-messages" id="chatMessages">
      <!-- Welcome message -->
      <div class="welcome-message" id="welcomeMessage">
        <h1 class="welcome-title">¡Hola! Soy tu Asistente Duran AI</h1>
        <p class="welcome-subtitle">
          Puedo ayudarte a encontrar productos, ubicaciones en el almacén y responder tus preguntas.
          Selecciona tu idioma preferido y comienza a chatear.
        </p>
        
        <!-- Language selector -->
        <div class="language-selector" id="languageSelector">
          <button class="language-flag active" data-lang="es" title="Español">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4MCcgaGVpZ2h0PSc0OCc+PHJlY3Qgd2lkdGg9JzgwJyBoZWlnaHQ9JzQ4JyBmaWxsPScjYWExNTFiJy8+PHJlY3QgeT0nMTYnIHdpZHRoPSc4MCcgaGVpZ2h0PScxNicgZmlsbD0nI2YxYmYwMCcvPjwvc3ZnPg==" alt="Español"/>
          </button>
          <button class="language-flag" data-lang="ca" title="Mallorquí">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4MCcgaGVpZ2h0PSc0OCc+PHJlY3Qgd2lkdGg9JzgwJyBoZWlnaHQ9JzQ4JyBmaWxsPScjZjdkMTE3Jy8+PGcgZmlsbD0nI2Q0MDAwMCc+PHJlY3QgeT0nNCcgd2lkdGg9JzgwJyBoZWlnaHQ9JzYnLz48cmVjdCB5PScxNCcgd2lkdGg9JzgwJyBoZWlnaHQ9JzYnLz48cmVjdCB5PScyNCcgd2lkdGg9JzgwJyBoZWlnaHQ9JzYnLz48cmVjdCB5PSczNCcgd2lkdGg9JzgwJyBoZWlnaHQ9JzYnLz48L2c+PC9zdmc+" alt="Mallorquí"/>
          </button>
          <button class="language-flag" data-lang="en" title="English">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4MCcgaGVpZ2h0PSc0OCc+PHJlY3Qgd2lkdGg9JzgwJyBoZWlnaHQ9JzQ4JyBmaWxsPScjMDAyNDdkJy8+PHBhdGggZD0nTTAsMCA4MCw0OCBNODAsMCAwLDQ4JyBzdHJva2U9JyNmZmYnIHN0cm9rZS13aWR0aD0nMTAnLz48cGF0aCBkPSdNMCwwIDgwLDQ4IE04MCwwIDAsNDgnIHN0cm9rZT0nI2NmMTQyYicgc3Ryb2tlLXdpZHRoPSc2Jy8+PHJlY3QgeD0nMzQnIHdpZHRoPScxMicgaGVpZ2h0PSc0OCcgZmlsbD0nI2ZmZicvPjxyZWN0IHk9JzE4JyB3aWR0aD0nODAnIGhlaWdodD0nMTInIGZpbGw9JyNmZmYnLz48cmVjdCB4PSczNicgd2lkdGg9JzgnIGhlaWdodD0nNDgnIGZpbGw9JyNjZjE0MmInLz48cmVjdCB5PScyMCcgd2lkdGg9JzgwJyBoZWlnaHQ9JzgnIGZpbGw9JyNjZjE0MmInLz48L3N2Zz4=" alt="English"/>
          </button>
        </div>
      </div>
    </div>

    <!-- Input area -->
    <div class="input-area">
      <div class="input-container">
        <div class="voice-indicator" id="voiceIndicator">
          🎙️ Escuchando...
        </div>
        
        <div class="input-wrapper">
          <textarea 
            class="message-input" 
            id="messageInput" 
            placeholder="Escribe tu mensaje aquí... (ej: manguito 32mm polietileno, scala2, código de barras)"
            rows="1"
          ></textarea>
          
          <div class="input-controls">
            <button class="control-btn" id="voiceBtn" title="Grabar mensaje de voz">
              🎙️
            </button>
            <button class="control-btn primary" id="sendBtn" title="Enviar mensaje">
              ➤
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results section (hidden by default) -->
  <div class="results-section" id="resultsSection">
    <h2>Resultados de búsqueda</h2>
    <div class="results-grid" id="resultsGrid">
      <!-- Results will be populated here -->
    </div>
  </div>

  <!-- Map section (hidden by default) -->
  <div class="map-section" id="mapSection">
    <h2>Ubicación del producto</h2>
    <div class="map-container">
      <img class="map-image" id="mapImage" src="calvia/plano-calvia.jpg" alt="Plano del almacén"/>
      <div class="map-pin" id="mapPin" style="display: none;"></div>
    </div>
    <div id="locationInfo" style="margin-top: 1rem; color: var(--text-secondary);"></div>
  </div>
</div>

<script>
// Application state and configuration
const APP_VERSION = 'v6.0-' + Date.now();

// N8N Webhook Configuration
const N8N_WEBHOOK_URL = 'https://primary-production-76c75.up.railway.app/webhook-test/074348a1-5924-4ddc-9215-2a6dcc2aaa1e';
const WEBHOOK_TIMEOUT = 120000; // 2 minutes timeout

// Center configuration
const CENTERS = {
  calvia: { id: 'calvia', label: 'Duran Calvià', a: 'calvia/Articulos.csv', u: 'calvia/ubicaciones.csv', map: 'calvia/plano-calvia.jpg' },
  coll: { id: 'coll', label: 'Duran Coll', a: 'coll/Articulos.csv', u: 'coll/ubicaciones.csv', map: 'coll/plano-coll.jpg' },
  alcudia: { id: 'alcudia', label: 'Duran Alcudia', a: 'alcudia/Articulos.csv', u: 'alcudia/ubicaciones.csv', map: 'alcudia/plano-alcudia.jpg' },
  santanyi: { id: 'santanyi', label: 'Duran Santanyí', a: 'santanyi/Articulos.csv', u: 'santanyi/ubicaciones.csv', map: 'santanyi/plano-santanyi.jpg' }
};

// Language configuration
const LANGUAGES = {
  es: {
    name: "Español",
    tag: "es-ES",
    greetings: {
      morning: "Buenos días",
      afternoon: "Buenas tardes",
      evening: "Buenas noches"
    },
    messages: {
      welcome: "¡Hola! Soy tu Asistente Duran AI. ¿En qué puedo ayudarte?",
      listening: "Escuchando...",
      thinking: "Procesando...",
      noResults: "No se encontraron resultados para tu búsqueda.",
      error: "Ha ocurrido un error. Por favor, inténtalo de nuevo."
    }
  },
  ca: {
    name: "Mallorquí", 
    tag: "ca-ES",
    greetings: {
      morning: "Bon dia",
      afternoon: "Bona tarda", 
      evening: "Bona nit"
    },
    messages: {
      welcome: "Hola! Som el teu Assistent Duran AI. En què et puc ajudar?",
      listening: "Escoltant...",
      thinking: "Processant...",
      noResults: "No s'han trobat resultats per la teva cerca.",
      error: "Ha ocorregut un error. Si us plau, torna-ho a intentar."
    }
  },
  en: {
    name: "English",
    tag: "en-GB", 
    greetings: {
      morning: "Good morning",
      afternoon: "Good afternoon",
      evening: "Good evening"
    },
    messages: {
      welcome: "Hello! I'm your Duran AI Assistant. How can I help you?",
      listening: "Listening...",
      thinking: "Processing...",
      noResults: "No results found for your search.",
      error: "An error occurred. Please try again."
    }
  }
};

// Application state
let currentLanguage = 'es';
let currentCenter = CENTERS[localStorage.getItem('centerId') || 'calvia'];
let currentTheme = localStorage.getItem('theme') || 'dark';
let isListening = false;
let recognition = null;
let articles = [];
let locations = [];

// DOM elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const voiceBtn = document.getElementById('voiceBtn');
const voiceIndicator = document.getElementById('voiceIndicator');
const themeToggle = document.getElementById('themeToggle');
const centerSelector = document.getElementById('centerSelector');
const languageSelector = document.getElementById('languageSelector');
const welcomeMessage = document.getElementById('welcomeMessage');
const resultsSection = document.getElementById('resultsSection');
const mapSection = document.getElementById('mapSection');

/**
 * Initialize the application
 */
function initializeApp() {
  setupTheme();
  setupLanguageSelector();
  setupCenterSelector();
  setupVoiceRecognition();
  setupInputHandlers();
  loadData();
  
  // Auto-focus on input
  messageInput.focus();
  
  // Setup textarea auto-resize
  setupTextareaResize();
}

/**
 * Setup theme switching functionality
 */
function setupTheme() {
  document.documentElement.setAttribute('data-theme', currentTheme);
  themeToggle.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
  
  themeToggle.addEventListener('click', () => {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', currentTheme);
    themeToggle.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
    localStorage.setItem('theme', currentTheme);
  });
}

/**
 * Setup language selector functionality
 */
function setupLanguageSelector() {
  const flags = languageSelector.querySelectorAll('.language-flag');
  
  flags.forEach(flag => {
    flag.addEventListener('click', () => {
      // Remove active class from all flags
      flags.forEach(f => f.classList.remove('active'));
      
      // Add active class to clicked flag
      flag.classList.add('active');
      
      // Update current language
      currentLanguage = flag.dataset.lang;
      
      // Update voice indicator text
      updateVoiceIndicatorText();
      
      // Speak welcome message in new language
      speakMessage(LANGUAGES[currentLanguage].messages.welcome);
    });
  });
}

/**
 * Setup center selector functionality
 */
function setupCenterSelector() {
  centerSelector.value = currentCenter.id;
  
  centerSelector.addEventListener('change', (e) => {
    currentCenter = CENTERS[e.target.value];
    localStorage.setItem('centerId', currentCenter.id);
    loadData();
  });
}

/**
 * Setup voice recognition functionality
 */
function setupVoiceRecognition() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = LANGUAGES[currentLanguage].tag;
    
    recognition.onstart = () => {
      isListening = true;
      voiceIndicator.classList.add('active');
      voiceBtn.style.background = 'var(--accent-primary)';
      voiceBtn.style.color = 'white';
    };
    
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      messageInput.value = transcript;
      messageInput.focus();
    };
    
    recognition.onend = () => {
      isListening = false;
      voiceIndicator.classList.remove('active');
      voiceBtn.style.background = '';
      voiceBtn.style.color = '';
    };
    
    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      isListening = false;
      voiceIndicator.classList.remove('active');
      voiceBtn.style.background = '';
      voiceBtn.style.color = '';
    };
  } else {
    voiceBtn.style.display = 'none';
  }
}

/**
 * Setup input handlers
 */
function setupInputHandlers() {
  // Send button click
  sendBtn.addEventListener('click', handleSendMessage);
  
  // Enter key to send (Shift+Enter for new line)
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  });
  
  // Voice button click
  voiceBtn.addEventListener('click', () => {
    if (recognition) {
      if (isListening) {
        recognition.stop();
      } else {
        recognition.lang = LANGUAGES[currentLanguage].tag;
        recognition.start();
      }
    }
  });
}

/**
 * Setup textarea auto-resize functionality
 */
function setupTextareaResize() {
  messageInput.addEventListener('input', () => {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
  });
}

/**
 * Update voice indicator text based on current language
 */
function updateVoiceIndicatorText() {
  voiceIndicator.textContent = `🎙️ ${LANGUAGES[currentLanguage].messages.listening}`;
}

/**
 * Handle sending a message
 */
async function handleSendMessage() {
  const message = messageInput.value.trim();
  if (!message) return;
  
  // Hide welcome message
  welcomeMessage.style.display = 'none';
  
  // Add user message to chat
  addMessage(message, 'user');
  
  // Clear input
  messageInput.value = '';
  messageInput.style.height = 'auto';
  
  // Show typing indicator
  const typingId = showTypingIndicator();
  
  // Process the message
  try {
    await processMessage(message);
  } catch (error) {
    console.error('Error processing message:', error);
    addMessage(LANGUAGES[currentLanguage].messages.error, 'ai');
  } finally {
    // Remove typing indicator
    removeTypingIndicator(typingId);
  }
  
  // Focus back on input
  messageInput.focus();
}

/**
 * Add a message to the chat
 */
function addMessage(content, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = sender === 'user' ? 'TÚ' : 'AI';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  messageContent.textContent = content;
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);
  
  chatMessages.appendChild(messageDiv);
  
  // Scroll to bottom
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // Speak AI messages
  if (sender === 'ai') {
    speakMessage(content);
  }
}

/**
 * Show typing indicator
 */
function showTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message ai';
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = 'AI';
  
  const typingIndicator = document.createElement('div');
  typingIndicator.className = 'typing-indicator';
  typingIndicator.innerHTML = `
    <div class="typing-dots">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    <span>${LANGUAGES[currentLanguage].messages.thinking}</span>
  `;
  
  typingDiv.appendChild(avatar);
  typingDiv.appendChild(typingIndicator);
  
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  return typingDiv;
}

/**
 * Remove typing indicator
 */
function removeTypingIndicator(typingElement) {
  if (typingElement && typingElement.parentNode) {
    typingElement.parentNode.removeChild(typingElement);
  }
}

/**
 * Process user message and generate response
 */
async function processMessage(message) {
  try {
    console.log('🚀 Starting processMessage with:', { message, language: currentLanguage, center: currentCenter.id });
    
    // Prepare the payload to send to N8N
    const payload = {
      message: message,
      language: currentLanguage,
      center: currentCenter.id,
      centerLabel: currentCenter.label,
      timestamp: new Date().toISOString(),
      articles: articles.slice(0, 100), // Send first 100 articles for context (avoid payload too large)
      locations: locations.slice(0, 100), // Send first 100 locations for context
      articlesCount: articles.length,
      locationsCount: locations.length
    };

    console.log('📦 Payload prepared for N8N:', {
      ...payload,
      articles: `${payload.articles.length} articles (truncated for logging)`,
      locations: `${payload.locations.length} locations (truncated for logging)`
    });
    console.log('🌐 Sending request to:', N8N_WEBHOOK_URL);

    // Create AbortController for timeout handling
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      console.error('⏰ Request timed out after', WEBHOOK_TIMEOUT / 1000, 'seconds');
      controller.abort();
    }, WEBHOOK_TIMEOUT);

    console.log('📡 Making fetch request...');
    const startTime = Date.now();

    // Send message to N8N webhook
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'User-Agent': 'Duran-AI-Assistant/1.0'
      },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    // Clear timeout if request completes
    clearTimeout(timeoutId);
    const responseTime = Date.now() - startTime;
    console.log(`✅ Response received in ${responseTime}ms, status:`, response.status, response.statusText);

    // Check if response is ok
    if (!response.ok) {
      console.error('❌ HTTP Error Response:', {
        status: response.status,
        statusText: response.statusText,
        headers: Object.fromEntries(response.headers.entries())
      });
      
      let errorBody = '';
      try {
        errorBody = await response.text();
        console.error('❌ Error response body:', errorBody);
      } catch (bodyError) {
        console.error('❌ Could not read error response body:', bodyError);
      }
      
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    console.log('📥 Parsing JSON response...');
    // Parse the response from N8N
    const aiResponse = await response.json();
    console.log('✨ Parsed AI response:', aiResponse);
    
    // Extract AI message from response
    let aiMessage = '';
    let showResultsData = null;
    let showLocationData = null;

    if (aiResponse.message) {
      aiMessage = aiResponse.message;
      console.log('💬 Using aiResponse.message');
    } else if (aiResponse.response) {
      aiMessage = aiResponse.response;
      console.log('💬 Using aiResponse.response');
    } else if (aiResponse.text) {
      aiMessage = aiResponse.text;
      console.log('💬 Using aiResponse.text');
    } else {
      aiMessage = 'He recibido tu mensaje, pero hubo un problema con la respuesta. ¿Podrías intentarlo de nuevo?';
      console.warn('⚠️ No message field found in response, using fallback');
    }

    // Check if AI wants to show search results
    if (aiResponse.showResults && Array.isArray(aiResponse.results)) {
      showResultsData = aiResponse.results;
      console.log('📊 Will show results:', showResultsData.length, 'items');
    }

    // Check if AI wants to show location
    if (aiResponse.showLocation && aiResponse.locationData) {
      showLocationData = aiResponse.locationData;
      console.log('📍 Will show location:', showLocationData);
    }

    console.log('✅ Processing completed successfully');

    // Add AI message to chat
    addMessage(aiMessage, 'ai');

    // Show results if provided
    if (showResultsData) {
      showResults(showResultsData);
    }

    // Show location if provided
    if (showLocationData) {
      showProductLocation(showLocationData);
    }

  } catch (error) {
    console.error('💥 Error in processMessage:', {
      name: error.name,
      message: error.message,
      stack: error.stack,
      cause: error.cause
    });
    
    // Handle different types of errors
    let errorMessage = '';
    
    if (error.name === 'AbortError') {
      console.error('⏰ Request was aborted due to timeout');
      errorMessage = 'La consulta está tardando demasiado. Por favor, inténtalo de nuevo con una pregunta más específica.';
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      console.error('🌐 Network connectivity issue detected');
      errorMessage = 'No puedo conectar con el servidor de IA en este momento. Por favor, verifica tu conexión a internet e inténtalo de nuevo.';
    } else if (error.message.includes('HTTP error')) {
      console.error('🚫 HTTP error from server');
      const statusMatch = error.message.match(/status: (\d+)/);
      const status = statusMatch ? statusMatch[1] : 'unknown';
      errorMessage = `El servidor de IA respondió con error ${status}. Por favor, inténtalo de nuevo en unos momentos.`;
    } else if (error.message.includes('JSON')) {
      console.error('📄 JSON parsing error - invalid response format');
      errorMessage = 'El servidor envió una respuesta en formato incorrecto. Por favor, inténtalo de nuevo.';
    } else {
      console.error('❓ Unknown error type');
      errorMessage = LANGUAGES[currentLanguage].messages.error;
    }
    
    addMessage(errorMessage, 'ai');
    
    // Fallback to local search if webhook fails
    if (error.name !== 'AbortError') {
      console.log('🔄 Attempting fallback to local search...');
      addMessage('Mientras tanto, puedo intentar una búsqueda local...', 'ai');
      const results = searchProducts(message);
      if (results.length > 0) {
        console.log('📋 Local search found', results.length, 'results');
        showResults(results);
      } else {
        console.log('🔍 Local search returned no results');
      }
    }
  }
}

/**
 * Get time-based greeting
 */
function getTimeBasedGreeting() {
  const hour = new Date().getHours();
  const greetings = LANGUAGES[currentLanguage].greetings;
  
  if (hour < 12) return greetings.morning;
  if (hour < 18) return greetings.afternoon;
  return greetings.evening;
}

/**
 * Search products (simplified version)
 */
function searchProducts(query) {
  if (!articles || articles.length === 0) {
    return [];
  }

  // Normalize query for better matching
  const normalizedQuery = query.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const keywords = query.toLowerCase().split(' ');
  
  // Search in actual articles data
  const results = articles.filter(article => {
    if (!article.Descripcion && !article.ReferenciaProveedor && !article.NumeroArticulo) {
      return false;
    }
    
    const description = (article.Descripcion || '').toLowerCase();
    const reference = (article.ReferenciaProveedor || '').toLowerCase();
    const articleNumber = (article.NumeroArticulo || '').toString().toLowerCase();
    const ean = (article.CodigoEAN || '').toLowerCase();
    
    return keywords.some(keyword => 
      description.includes(keyword) ||
      reference.includes(keyword) ||
      articleNumber.includes(keyword) ||
      ean.includes(keyword)
    );
  }).slice(0, 10); // Limit to 10 results
  
  // Transform to expected format
  return results.map(article => {
    // Find location for this article
    const location = locations.find(loc => loc.NumeroArticulo === article.NumeroArticulo);
    const locationText = location ? 
      `Pasillo ${location.Pasillo}, Lado ${location.Lado}, Estante ${location.Estante}, Balda ${location.Balda}` :
      'Ubicación no disponible';
    
    return {
      id: article.NumeroArticulo,
      name: article.Descripcion || 'Sin descripción',
      reference: article.ReferenciaProveedor || 'Sin referencia',
      price: article.Precio ? `€${article.Precio}` : 'Precio no disponible',
      stock: article.Stock || 0,
      location: locationText,
      ean: article.CodigoEAN || '',
      provider: article.NombreProveedor || '',
      coordinates: location ? { x: location.X, y: location.Y } : null
    };
  });
}

/**
 * Show search results
 */
function showResults(results) {
  const resultsGrid = document.getElementById('resultsGrid');
  resultsGrid.innerHTML = '';
  
  results.forEach(product => {
    const resultItem = document.createElement('div');
    resultItem.className = 'result-item';
    resultItem.innerHTML = `
      <div class="result-title">${product.name}</div>
      <div class="result-details">
        <div>Referencia: ${product.reference}</div>
        <div>Precio: ${product.price} + IVA</div>
        <div>Stock: ${product.stock} unidades</div>
        <div>Ubicación: ${product.location}</div>
      </div>
    `;
    
    resultItem.addEventListener('click', () => {
      showProductLocation(product);
    });
    
    resultsGrid.appendChild(resultItem);
  });
  
  resultsSection.classList.add('active');
  resultsSection.scrollIntoView({ behavior: 'smooth' });
}

/**
 * Show product location on map
 */
function showProductLocation(product) {
  addMessage(`Perfecto! Te muestro la ubicación exacta de "${product.name}" en el mapa del almacén.`, 'ai');
  
  // Update map image
  const mapImage = document.getElementById('mapImage');
  mapImage.src = currentCenter.map;
  
  // Show location info
  const locationInfo = document.getElementById('locationInfo');
  locationInfo.innerHTML = `
    <strong>${product.name}</strong><br>
    📍 ${product.location}<br>
    💰 ${product.price} + IVA<br>
    📦 Stock: ${product.stock} unidades
  `;
  
  // Show map pin (mock coordinates)
  const mapPin = document.getElementById('mapPin');
  mapPin.style.left = '60%';
  mapPin.style.top = '40%';
  mapPin.style.display = 'block';
  
  mapSection.classList.add('active');
  mapSection.scrollIntoView({ behavior: 'smooth' });
}

/**
 * Speak message using Web Speech API
 */
function speakMessage(text) {
  if ('speechSynthesis' in window) {
    // Cancel any ongoing speech
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = LANGUAGES[currentLanguage].tag;
    utterance.rate = 0.9;
    utterance.pitch = 1;
    utterance.volume = 0.8;
    
    // Try to find a suitable voice
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(voice => 
      voice.lang.startsWith(currentLanguage) || 
      voice.lang.startsWith(LANGUAGES[currentLanguage].tag.substring(0, 2))
    );
    
    if (preferredVoice) {
      utterance.voice = preferredVoice;
    }
    
    speechSynthesis.speak(utterance);
  }
}

/**
 * Load data from CSV files
 */
async function loadData() {
  try {
    console.log(`📂 Loading data for center: ${currentCenter.label}`);
    
    // Load articles CSV
    try {
      console.log('📄 Fetching articles from:', currentCenter.a);
      const articlesResponse = await fetch(currentCenter.a);
      if (articlesResponse.ok) {
        const articlesText = await articlesResponse.text();
        articles = parseCSV(articlesText);
        console.log('✅ Articles loaded:', articles.length, 'items');
      } else {
        console.warn(`⚠️ Could not load articles for ${currentCenter.id}, status:`, articlesResponse.status);
        articles = [];
      }
    } catch (error) {
      console.warn(`❌ Error loading articles: ${error.message}`);
      articles = [];
    }
    
    // Load locations CSV
    try {
      console.log('📍 Fetching locations from:', currentCenter.u);
      const locationsResponse = await fetch(currentCenter.u);
      if (locationsResponse.ok) {
        const locationsText = await locationsResponse.text();
        locations = parseCSV(locationsText);
        console.log('✅ Locations loaded:', locations.length, 'items');
      } else {
        console.warn(`⚠️ Could not load locations for ${currentCenter.id}, status:`, locationsResponse.status);
        locations = [];
      }
    } catch (error) {
      console.warn(`❌ Error loading locations: ${error.message}`);
      locations = [];
    }
    
    // Update counters with real data
    console.log('🔢 Updating data counters...');
    updateDataCounters();
    
    // Update map image
    const mapImage = document.getElementById('mapImage');
    if (mapImage) {
      mapImage.src = currentCenter.map;
      console.log('🗺️ Map image updated to:', currentCenter.map);
    }
    
  } catch (error) {
    console.error('💥 Error loading data:', error);
  }
}

/**
 * Update data counters in header
 */
function updateDataCounters() {
  const articleCount = document.getElementById('articleCount');
  const locationCount = document.getElementById('locationCount');
  
  if (articleCount && locationCount) {
    // Display actual counts from loaded CSV data
    articleCount.textContent = articles.length.toLocaleString();
    locationCount.textContent = locations.length.toLocaleString();
  }
}

/**
 * Utility function to parse CSV (simplified)
 */
function parseCSV(text) {
  const lines = text.split('\n').filter(line => line.trim());
  if (lines.length === 0) return [];
  
  const headers = lines[0].split(';').map(h => h.trim());
  const rows = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(';').map(v => v.trim());
    const row = {};
    headers.forEach((header, index) => {
      row[header] = values[index] || '';
    });
    rows.push(row);
  }
  
  return rows;
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);

// Handle window resize for responsive design
window.addEventListener('resize', () => {
  // Adjust chat messages height if needed
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
});

// Clean up speech synthesis on page unload
window.addEventListener('beforeunload', () => {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
  }
});
</script>
</body>
</html>